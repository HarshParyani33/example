<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SafeScan Web</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
pre { max-height: 420px; overflow: auto; }
</style>
</head>
<body>
<div class="overlay" id="loadingOverlay"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>
<div class="container mt-5 glass p-4">
    <h1 class="text-center mb-4">SafeScan Web Security Scanner</h1>

    <form method="POST" class="mb-4" onsubmit="document.getElementById('loadingOverlay').style.display='flex'">
        <input type="text" name="url" class="form-control mb-3" placeholder="Enter URL (e.g., https://example.com)" required>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="xss" checked>
            <label class="form-check-label">XSS</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="redirect" checked>
            <label class="form-check-label">Open Redirect</label>
        </div>
        <div class="form-check form-check-inline mb-3">
            <input class="form-check-input" type="checkbox" name="headers" checked>
            <label class="form-check-label">HTTP Headers</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="sqli" checked>
            <label class="form-check-label">SQL Injection (error-based)</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="cors" checked>
            <label class="form-check-label">CORS Misconfig</label>
        </div>
        <div class="form-check form-check-inline mb-3">
            <input class="form-check-input" type="checkbox" name="cookies" checked>
            <label class="form-check-label">Cookie Flags</label>
        </div>
        <button class="btn btn-warning w-100 fw-bold">Run Scan</button>
    </form>

    {% if result %}
    <h3 class="mt-4">Scan Summary:</h3>
    <div style="height:260px">
        <canvas id="summaryChart"></canvas>
    </div>

    <ul class="nav nav-tabs mt-3" id="resultTabs" role="tablist">
        {% for key in result.keys() %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}" id="{{key}}-tab" data-bs-toggle="tab" data-bs-target="#{{key}}" type="button" role="tab">{{ key | capitalize }}</button>
        </li>
        {% endfor %}
    </ul>

    <div class="tab-content p-3 border bg-light" id="resultTabsContent">
        {% for key, data in result.items() %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{key}}" role="tabpanel">
            {% if key == 'headers' %}
                {% set missing = data.missing_headers or [] %}
                {% if missing %}
                    <div class="alert alert-danger">Missing security headers detected.</div>
                    <div class="list-group">
                        {% for h in missing %}
                        <div class="list-group-item result-card bad d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">{{ h.header }}</div>
                                <small class="text-muted">Recommended to set. Severity: <span class="badge bg-danger badge-sev">{{ h.severity }}</span></small>
                            </div>
                            <span class="badge bg-danger">Missing</span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-success">All recommended security headers present.</div>
                {% endif %}
            {% elif key == 'meta' %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Scan Metadata</h5>
                                <ul class="list-unstyled mb-0">
                                    <li><strong>URL:</strong> {{ data.url }}</li>
                                    <li><strong>Timestamp (UTC):</strong> {{ data.timestamp }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Selected Checks</h6>
                                {% set checks = data.selected_checks or {} %}
                                {% if checks %}
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for ck, on in checks.items() %}
                                            {% if on %}<span class="badge bg-primary text-wrap">{{ ck | upper }}</span>{% endif %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">No checks selected.</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% elif key in ['xss','redirect','sqli','cors','cookies'] %}
                {% if data.error %}
                    <div class="alert alert-warning">{{ data.error }}</div>
                {% else %}
                    {% if data.vulnerable %}
                        <div class="alert alert-danger">Vulnerabilities found in {{ key | upper }}.</div>
                        <div class="list-group">
                            {% for item in data.details %}
                            <div class="list-group-item result-card bad">
                                <div class="fw-bold">Issue</div>
                                <div><small class="text-muted">{{ item | tojson }}</small></div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-success">No vulnerabilities detected for {{ key | upper }}.</div>
                    {% endif %}
                {% endif %}
            {% else %}
                <pre>{{ data | tojson(indent=2) }}</pre>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script id="summary-data" type="application/json">{{ summary | tojson | safe }}</script>
{% if result %}
<script id="result-data" type="application/json">{{ result | tojson | safe }}</script>
{% endif %}
<script>
const summaryData = JSON.parse(document.getElementById('summary-data').textContent || '{}');
const canvasEl = document.getElementById('summaryChart');
const ctx = canvasEl ? canvasEl.getContext('2d') : null;
const totalFindings = (summaryData.critical || 0) + (summaryData.high || 0) + (summaryData.medium || 0) + (summaryData.low || 0);
const resultData = (document.getElementById('result-data') && JSON.parse(document.getElementById('result-data').textContent || '{}')) || {};

function buildSeverityContrib(resultObj) {
    const contrib = { critical: [], high: [], medium: [], low: [] };
    if (!resultObj || typeof resultObj !== 'object') return contrib;
    // XSS -> critical
    if (resultObj.xss && resultObj.xss.vulnerable) {
        const n = (resultObj.xss.details || []).length || 1;
        contrib.critical.push(`XSS: ${n}`);
    }
    // SQLi -> high
    if (resultObj.sqli && resultObj.sqli.vulnerable) {
        const n = (resultObj.sqli.details || []).length || 1;
        contrib.high.push(`SQLi: ${n}`);
    }
    // Open Redirect -> high
    if (resultObj.redirect && resultObj.redirect.vulnerable) {
        const n = (resultObj.redirect.details || []).length || 1;
        contrib.high.push(`Open Redirect: ${n}`);
    }
    // CORS -> medium
    if (resultObj.cors && resultObj.cors.vulnerable) {
        const n = (resultObj.cors.details || []).length || 1;
        contrib.medium.push(`CORS: ${n}`);
    }
    // Cookies -> low
    if (resultObj.cookies && resultObj.cookies.vulnerable) {
        const n = (resultObj.cookies.details || []).length || 1;
        contrib.low.push(`Cookies: ${n}`);
    }
    // Headers -> per missing header severity
    if (resultObj.headers && resultObj.headers.missing_headers) {
        const missing = resultObj.headers.missing_headers || [];
        const buckets = { critical: [], high: [], medium: [], low: [] };
        missing.forEach(function(h){
            const sev = (h.severity || '').toLowerCase();
            if (sev && buckets[sev] !== undefined) buckets[sev].push(h.header || 'Header');
        });
        Object.keys(buckets).forEach(function(s){
            if (buckets[s].length) {
                // List up to 3 names to keep tooltip concise
                const names = buckets[s].slice(0,3).join(', ');
                const more = buckets[s].length > 3 ? ` +${buckets[s].length - 3} more` : '';
                contrib[s].push(`Headers: ${names}${more}`);
            }
        });
    }
    return contrib;
}

const severityContrib = buildSeverityContrib(resultData);

if (ctx) {
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [
                    summaryData.critical || 0,
                    summaryData.high || 0,
                    summaryData.medium || 0,
                    summaryData.low || 0
                ],
                backgroundColor: ['#dc3545','#fd7e14','#ffc107','#198754'],
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Findings by severity' + (totalFindings ? ` (Total: ${totalFindings})` : '')
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (!data.labels || !data.labels.length) return [];
                            const values = data.datasets[0].data;
                            const tot = values.reduce(function(a, b){ return a + b; }, 0);
                            const meta = chart.getDatasetMeta(0);
                            return data.labels.map(function(label, i){
                                const v = values[i] || 0;
                                const pct = tot ? ((v / tot) * 100).toFixed(1) : '0.0';
                                const style = meta.controller.getStyle(i);
                                return {
                                    text: label + ': ' + v + ' (' + pct + '%)',
                                    fillStyle: style.backgroundColor,
                                    strokeStyle: style.borderColor,
                                    lineWidth: style.borderWidth,
                                    hidden: isNaN(values[i]) || meta.data[i].hidden,
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const v = context.parsed;
                            const tot = totalFindings || 0;
                            const pct = tot ? ((v / tot) * 100).toFixed(1) : '0.0';
                            const sev = (context.label || '').toLowerCase();
                            const parts = severityContrib[sev] && severityContrib[sev].length ? ' — from ' + severityContrib[sev].join('; ') : '';
                            return context.label + ': ' + v + ' (' + pct + '%)' + parts;
                        }
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false
        }
    });
}
</script>
</body>
</html>
