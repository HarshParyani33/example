<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SafeScan Web</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
pre { max-height: 420px; overflow: auto; }
</style>
</head>
<body>
<div class="container mt-5 glass p-4">
    <div class="d-flex justify-content-end mb-2">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="theme-toggle">
            <label class="form-check-label" for="theme-toggle"><i class="fas fa-moon"></i></label>
        </div>
    </div>
    <div class="text-center mb-4">
        <h1 class="display-4">Find Web Vulnerabilities in Seconds.</h1>
        <p class="lead">Safe-scan is a free, open-source tool to check your website for common security issues like SQL Injection, XSS, and more.</p>
    </div>

    <form method="POST" class="mb-4">
        <input type="text" name="url" class="form-control mb-3" placeholder="Enter URL (e.g., https://example.com)" required>
        <div class="d-flex flex-wrap gap-2 mb-3 justify-content-center">
            <button type="button" class="btn scan-option-btn selected" data-check="xss">XSS</button>
            <input type="hidden" name="xss" value="true">
            <button type="button" class="btn scan-option-btn selected" data-check="redirect">Open Redirect</button>
            <input type="hidden" name="redirect" value="true">
            <button type="button" class="btn scan-option-btn selected" data-check="headers">HTTP Headers</button>
            <input type="hidden" name="headers" value="true">
            <button type="button" class="btn scan-option-btn selected" data-check="sqli">SQL Injection</button>
            <input type="hidden" name="sqli" value="true">
            <button type="button" class="btn scan-option-btn selected" data-check="cors">CORS Misconfig</button>
            <input type="hidden" name="cors" value="true">
            <button type="button" class="btn scan-option-btn selected" data-check="cookies">Cookie Flags</button>
            <input type="hidden" name="cookies" value="true">
        </div>
        <button class="btn btn-warning w-100 fw-bold">Run Scan</button>
    </form>

    <div id="scan-progress" class="mb-4" style="display: none;">
        <div class="progress">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
        <div id="live-log" class="mt-2 text-muted text-center"></div>
    </div>

    {% if result %}
    <h3 class="mt-4">Scan Summary:</h3>
    <div style="height:260px">
        <canvas id="summaryChart"></canvas>
    </div>

    <ul class="nav nav-tabs mt-3" id="resultTabs" role="tablist">
        {% for key in result.keys() %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}" id="{{key}}-tab" data-bs-toggle="tab" data-bs-target="#{{key}}" type="button" role="tab">{{ key | capitalize }}</button>
        </li>
        {% endfor %}
    </ul>

    <div class="tab-content p-3 border" id="resultTabsContent">
        {% for key, data in result.items() %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{key}}" role="tabpanel">
            {% if key == 'headers' %}
                {% set missing = data.missing_headers or [] %}
                {% if missing %}
                    <div class="alert alert-danger">Missing security headers detected.</div>
                    <div class="list-group">
                        {% for h in missing %}
                        <div class="list-group-item result-card bad d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">{{ h.header }}</div>
                                <small class="text-muted">Recommended to set. Severity: <span class="badge bg-danger badge-sev">{{ h.severity }}</span></small>
                            </div>
                            <span class="badge bg-danger">Missing</span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-success">All recommended security headers present.</div>
                {% endif %}
            {% elif key == 'meta' %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Scan Metadata</h5>
                                <ul class="list-unstyled mb-0">
                                    <li><strong>URL:</strong> {{ data.url }}</li>
                                    <li><strong>Timestamp (UTC):</strong> {{ data.timestamp }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Selected Checks</h6>
                                {% set checks = data.selected_checks or {} %}
                                {% if checks %}
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for ck, on in checks.items() %}
                                            {% if on %}<span class="badge bg-primary text-wrap">{{ ck | upper }}</span>{% endif %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">No checks selected.</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% elif key in ['xss','redirect','sqli','cors','cookies'] %}
                {% if data.error %}
                    <div class="alert alert-warning">{{ data.error }}</div>
                {% else %}
                    {% if data.vulnerable %}
                        <div class="alert alert-danger">Vulnerabilities found in {{ key | upper }}.</div>
                        <div class="list-group">
                            {% for item in data.details %}
                            <div class="list-group-item result-card bad">
                                <div class="fw-bold">Issue</div>
                                <div><small class="text-muted">{{ item | tojson }}</small></div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-success">No vulnerabilities detected for {{ key | upper }}.</div>
                    {% endif %}
                {% endif %}
            {% else %}
                <pre>{{ data | tojson(indent=2) }}</pre>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script id="summary-data" type="application/json">{{ summary | tojson | safe }}</script>
{% if result %}
<script id="result-data" type="application/json">{{ result | tojson | safe }}</script>
{% endif %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>